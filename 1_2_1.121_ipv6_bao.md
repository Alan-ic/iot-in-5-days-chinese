# 1.2.1 IPv6 包
-----------
你需要知道的第一件事是 IPv6 包长啥样。在我们之前看到的分层模型中，每一层都添加该层自身相关的信息，而这些被添加的信息只能由另一个 IP 设备的对等层处理。不同设备的对等层之间的“对话”必须按照一个协议。

因特网的分层包括：
* **应用层**：这里驻有程序员利用网络协议栈提供的网络服务开发的软件。比如网页浏览器，它向网页服务器发送一个连接请求。又比如网页服务器，它运行在因特网中的某个服务器上等待来自客户端浏览器的请求。应用层协议包括 HTTP、DNS 等。
* **传输层**：传输层位于网络层之上，并给网络层提供附加功能，比如转发丢失的数据包，或者保证包按照发送的顺序接收。本层为应用层提供一个“网络服务”，用于发送或接收数据。TCP/UDP 是传输层中最常见的协议。
* **网络层**：这一层负责正确交付从传输层下发的数据，以及接收从链路层上传的数据。因特网在这一层只使用了一个协议 —— IP。IP 地址用来标识源和目的地。
* **链路层**：该层负责发送和接收帧 —— 网络层发送过来的字节的集合。它指定了相关了机制，用于在不同节点间共享媒介。
* **物理层**：该层负责电信号处理。通过有线或者无线物理媒介获取或发送从一个节点到另一个节点的的数字信息。

下图描述了如下的思想：每一层接收上一层传递下来的一些字节信息，然后添加一些相关的附加信息，接收端主机的对等层负责处理这些对应的附加信息。在本图中，数据来源于应用层，被发送到物理层。

<center><img src="images/iot_in_five_days/1/image002.png" /></center>
<center>图1.2. 协议栈中的数据流</center>

IP包中的发送、接收字节遵循一个标准格式，下图是IPv6头部的基本结构：

<center><img src="images/iot_in_five_days/1/image003.png" /></center>
<center>图1.3. IPv6 头</center>

最开始，是一个大小固定的 40 个字节的**IPv6 基本头**，接着是上层数据和一些可选的扩展头(将在后面介绍)。如图所示，包头被分为几个字段。与 IPv4 头部相比，IPv6 的头部有如下的改进：
* 字段数由 12 个减至 8 个。
* 基本的 IPv6 头是大小固定的，一共 40 个字节，且是 64 位对齐的，这样的好处是允许在路由器上进行基于硬件的快速转发。
* 地址的长度由 32 位增加至 128 位。

在 IPv6 头部中，最重要字段是源地址和目的地址。IP 地址是每个 IP 设备在因特网上独一无二的标识。路由器利用 IP 地址进行转发决策。

每个 IPv6 地址有 128 位，这相当于有 2^128 个地址(大约是 3.4x10^38)，而 IPv4 的地址使用 32 位编码方式，一共只有 2^32 个地址。

除了基本头之外，还有一个上面提到的**扩展头**。为了保证基本头的简单性和固定大小，附加信息以扩展头的形式被添加到 IPv6 头部。

<center><img src="images/iot_in_five_days/1/image004.png" /></center>
<center>图1.4. IPv6 扩展头</center>

有几个扩展头已经被定义了，正如上图所示。扩展头必须按照上图中的顺序。扩展头具有如下特性：
* 扩展头具有灵活性。例如，计算包中数据以保证数据安全。
* 扩展头能够优化包处理过程。因为除逐跳传输头之外，扩展都只被终节点处理(包的源节点和最终目的节点)，而不会被传输路径中的路由处理。
* 扩展头在基本头的后面。扩展头有一个字段叫做"next header",指向下一个扩展头。多个扩展头通过"next header"字段形成一个链式结构。